<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
          "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.kos.tr.app.dao.TerraAppDAO">

<select id="appSelectAll" parameterType="appdocvo" resultType="appdocvo">
		SELECT  
              COALESCE (A.ANUM, B.ANUM, C.ANUM) AS ANUM
             ,COALESCE (A.VSUBJECT, B.DSUBJECT,C.ESUBJECT) AS SUBJECT
             ,D.MNAME
             ,D.MPOSITION 
             ,AA.AAPP
             ,AA.AAUTH
             ,AA.ATYPE
             ,AA.ALEVEL
             ,TO_CHAR(AA.INSERTDATE, 'YYYY-MM-DD') AS INSERTDATE
             ,AA.FINDATE
      FROM   TR_VACATION A, TR_DRAFT B, TR_EXPAND C, TR_MEMBER D,
            (SELECT  * 
             FROM		TR_APPROVAL 
           	 WHERE 		<![CDATA[AAPP LIKE '%' || #{mnum, jdbcType=VARCHAR} || '%']]>
             ) AA
      WHERE  AA.ANUM = A.ANUM(+) 
      AND    AA.ANUM = B.ANUM(+) 
      AND    AA.ANUM = C.ANUM(+)
      AND    AA.MNUM = D.MNUM(+)
      AND 	<![CDATA[TO_NUMBER(AA.ALEVEL)> 0]]>
      AND 	<![CDATA[TO_NUMBER(AA.ALEVEL)< 9]]>

</select>

<select id="appSelectDraft" parameterType="appdocvo" resultType="appdocvo">

SELECT * FROM  (
	SELECT  
	
              COALESCE (A.ANUM, B.ANUM, C.ANUM) AS ANUM
             ,COALESCE (A.VSUBJECT, B.DSUBJECT,C.ESUBJECT) AS SUBJECT
             ,D.MNAME
             ,D.MPOSITION 
             ,AA.AAPP
             ,AA.AAUTH
             ,AA.ATYPE
             ,AA.ALEVEL
             ,AA.INSERTDATE
             ,AA.FINDATE
             ,CEIL(ROW_NUMBER() OVER(ORDER BY AA.ANUM DESC)/ #{pageSize} ) pageSize
			 ,COUNT(AA.ANUM) OVER() AS totalCount 	      
      FROM   TR_VACATION A, TR_DRAFT B, TR_EXPAND C, TR_MEMBER D,
            (SELECT  * 
             FROM		TR_APPROVAL 
           	 WHERE 		MNUM = #{mnum}
             ) AA
      WHERE  AA.ANUM = A.ANUM(+) 
      AND    AA.ANUM = B.ANUM(+) 
      AND    AA.ANUM = C.ANUM(+)
      AND    AA.MNUM = D.MNUM(+)
      AND 	<![CDATA[TO_NUMBER(AA.ALEVEL)> 0]]>
      ) WHERE pageSize = #{curPage}
</select>

<select id="appSelectAllDoc" parameterType="appdocvo" resultType="appdocvo">

	SELECT * FROM  (
	SELECT  
              COALESCE (A.ANUM, B.ANUM, C.ANUM) AS ANUM
             ,COALESCE (A.VSUBJECT, B.DSUBJECT,C.ESUBJECT) AS SUBJECT
             ,D.MNAME
             ,D.MPOSITION 
             ,AA.AAPP
             ,AA.AAUTH
             ,AA.ATYPE
             ,AA.ALEVEL
             ,AA.INSERTDATE
             ,AA.FINDATE
             ,CEIL(ROW_NUMBER() OVER(ORDER BY AA.ANUM DESC)/ #{pageSize} ) pageSize
			 ,COUNT(AA.ANUM) OVER() AS totalCount 	      
      FROM   TR_VACATION A, TR_DRAFT B, TR_EXPAND C, TR_MEMBER D,
            (SELECT  * 
             FROM		TR_APPROVAL 
           	 WHERE 		<![CDATA[AAPP LIKE '%' || #{mnum, jdbcType=VARCHAR} || '%']]>
             OR			MNUM = #{mnum}
             OR			<![CDATA[AREF LIKE '%' || #{mnum, jdbcType=VARCHAR} || '%']]>
             OR			(<![CDATA[TO_NUMBER(AAUTH) <= TO_NUMBER((SELECT MPOSITION FROM TR_MEMBER WHERE MNUM = #{mnum}]]>)))) AA
      WHERE  AA.ANUM = A.ANUM(+) 
      AND    AA.ANUM = B.ANUM(+) 
      AND    AA.ANUM = C.ANUM(+)
      AND    AA.MNUM = D.MNUM(+)
      AND 	<![CDATA[TO_NUMBER(AA.ALEVEL)> 0]]>
      ) WHERE pageSize = #{curPage}
</select>

<select id="appSelectRef" parameterType="appdocvo" resultType="appdocvo">
	SELECT * FROM  (
		SELECT  
              COALESCE (A.ANUM, B.ANUM, C.ANUM) AS ANUM
             ,COALESCE (A.VSUBJECT, B.DSUBJECT,C.ESUBJECT) AS SUBJECT
             ,D.MNAME
             ,D.MPOSITION 
             ,AA.AAPP
             ,AA.AAUTH
             ,AA.ATYPE
             ,AA.ALEVEL
             ,AA.INSERTDATE
             ,AA.FINDATE
             ,CEIL(ROW_NUMBER() OVER(ORDER BY AA.ANUM DESC)/ #{pageSize} ) pageSize
			 ,COUNT(AA.ANUM) OVER() AS totalCount 	      
      FROM   TR_VACATION A, TR_DRAFT B, TR_EXPAND C, TR_MEMBER D,
            (SELECT  * 
             FROM		TR_APPROVAL 
           	 WHERE 		<![CDATA[AREF LIKE '%' || #{aref, jdbcType=VARCHAR} || '%']]>
     		) AA
      WHERE  AA.ANUM = A.ANUM(+) 
      AND    AA.ANUM = B.ANUM(+) 
      AND    AA.ANUM = C.ANUM(+)
      AND    AA.MNUM = D.MNUM(+)
      AND <![CDATA[TO_NUMBER(AA.ALEVEL)> 0 ]]>	 
      ) WHERE pageSize = #{curPage}
</select>

<insert id="appDraftInsert" parameterType="appdraftvo">
   INSERT ALL
      INTO TR_APPROVAL (
                      ANUM
                     ,MNUM
                     ,AAPP
                     ,AREF
                     ,ALEVEL
                     ,AAUTH
                     ,DELETEYN
                     ,ATYPE
                     ,INSERTDATE
                     ,UPDATEDATE
                     ,DELETEDATE
                     ,FINDATE      
                     ,ACONFIRM
                  )
      VALUES   (	#{anum},
              	 	#{mnum},
              		#{aapp},
               		#{aref},
               		#{alevel},
               		#{aauth},
               'Y', 
               #{atype},
               SYSDATE,
               SYSDATE,
               ADD_MONTHS(SYSDATE , (#{deletedate} * 12)),
               SYSDATE,
               '`,`,`,`,`,')
      INTO TR_DRAFT ( ANUM
                     ,DSUBJECT
                     ,DMEMO
                     ,DFILE)
      VALUES (	#{anum},
            	#{dsubject},
            	#{dmemo},
            	#{dfile}	)
   SELECT * FROM DUAL


</insert>

<insert id="appVacationInsert" parameterType="appvacationvo">
   INSERT ALL
      INTO TR_APPROVAL (
                      ANUM
                     ,MNUM
                     ,AAPP
                     ,AREF
                     ,ALEVEL
                     ,AAUTH
                     ,DELETEYN
                     ,ATYPE
                     ,INSERTDATE
                     ,UPDATEDATE
                     ,DELETEDATE
                     ,FINDATE      
                     ,ACONFIRM
                  )
      VALUES   (
               #{anum},
               #{mnum},
               #{aapp},
               #{aref},
               #{alevel},
               #{aauth},
               'Y',
               #{atype},
               SYSDATE,
               SYSDATE,
               ADD_MONTHS(SYSDATE , (#{deletedate} * 12)),
               SYSDATE,
               '`,`,`,`,`,'
            )
      INTO TR_VACATION (
                      ANUM
                     ,VSUBJECT
                     ,VMEMO
                     ,VFILE
                     ,STARTDATE
                     ,ENDDATE
                  )
      VALUES (
            #{anum},
            #{vsubject},
            #{vmemo},
            #{vfile},
            #{startdate},
            #{enddate}            
      )
   SELECT * FROM DUAL


</insert>



<insert id="appExpandInsert" parameterType="appexpandvo">

   INSERT ALL
      INTO TR_APPROVAL(
                      ANUM
                     ,MNUM
                     ,AAPP
                     ,AREF
                     ,ALEVEL
                     ,AAUTH
                     ,DELETEYN
                     ,ATYPE
                     ,INSERTDATE
                     ,UPDATEDATE
                     ,DELETEDATE
                     ,FINDATE      
                     ,ACONFIRM
                  )
      VALUES (
               #{anum},
               #{mnum},
               #{aapp},
               #{aref},
               #{alevel},
               #{aauth},
               'Y',
               #{atype},
               SYSDATE,
               SYSDATE,
               ADD_MONTHS(SYSDATE , (#{deletedate} * 12)),
               SYSDATE,   
               '`,`,`,`,`,'
            )
      INTO TR_EXPAND (
                      ANUM
                     ,ESUBJECT
                     ,ETYPE
                     ,EDEAL
                     ,EWHEN
                     ,EMEMO
                     ,EAMOUNT
                     ,EPRICE
                     ,ECARD
                     ,EFILE
                  )
      VALUES (
               #{anum},
               #{esubject},
               #{etype},
               #{edeal},
               #{ewhen},
               #{ememo},
               #{eamount},
               #{eprice},
               #{ecard},
               #{efile}
            )
   SELECT * FROM DUAL



</insert>


<select id="appSelectContentD" parameterType="appdocvo" resultType="appdraftvo">

		SELECT  
			 A.ATYPE AS ATYPE
			,A.ANUM AS ANUM 
			,A.ALEVEL AS ALEVEL
			,C.MDEPTNO AS MDEPTNO
			,C.MNAME AS MNAME
			,(SELECT ROUND(MONTHS_BETWEEN(DELETEDATE, INSERTDATE) / 12) FROM TR_APPROVAL WHERE ANUM = #{anum}) AS DELETEDATE
			,A.AAUTH AS AAUTH
			,A.INSERTDATE AS INSERTDATE
			,A.FINDATE AS FINDATE
			,A.ACONFIRM AS ACONFIRM
			,A.DELETEDATE AS DELETEDATE
			,(CASE WHEN D.PAPP IS NULL THEN A.AAPP
          	  ELSE D.PAPP END) AAPP
			,A.AREF  AS AREF
			,B.DSUBJECT AS DSUBJECT
			,B.DMEMO  AS DMEMO 
	FROM 	TR_APPROVAL A, TR_DRAFT B, TR_MEMBER C, TR_PROXY D
	WHERE 	C.MNUM = A.MNUM 
	AND 	A.ANUM = B.ANUM
	AND 	A.ANUM = D.ANUM(+)
	AND 	A.ANUM = #{anum}

</select>

<select id="appSelectContentV" parameterType="appdocvo" resultType="appvacationvo">

		SELECT
				 A.ATYPE AS ATYPE
				,A.ANUM AS ANUM
				,A.ALEVEL AS ALEVEL
				,C.MDEPTNO AS MDEPTNO
				,C.MNAME AS MNAME
				,(SELECT ROUND(MONTHS_BETWEEN(DELETEDATE, INSERTDATE) / 12) FROM TR_APPROVAL WHERE ANUM = #{anum}) AS DELETEDATE 
				,A.AAUTH AS AAUTH
				,TO_CHAR(A.INSERTDATE,'YYYY-MM-DD HH24:mm') AS INSERTDATE
				,TO_CHAR(A.FINDATE, 'YYYY-MM-DD HH24:mm') AS FINDATE
				,A.ACONFIRM AS ACONFIRM
				,A.DELETEDATE AS DELETEDATE
				,(CASE WHEN D.PAPP IS NULL THEN A.AAPP
	          	  ELSE D.PAPP END) AAPP
				,A.AREF  AS AREF
				,B.VSUBJECT AS VSUBJECT
				,B.VMEMO AS VMEMO
				,TO_CHAR(B.STARTDATE, 'YYYY-MM-DD') AS STARTDATE
				,TO_CHAR(B.ENDDATE, 'YYYY-MM-DD') AS ENDDATE 				
		FROM	TR_APPROVAL A, TR_VACATION B, TR_MEMBER C, TR_PROXY D
		WHERE	C.MNUM = A.MNUM
		AND		A.ANUM = B.ANUM
		AND 	A.ANUM = D.ANUM(+)
		AND		A.ANUM = #{anum}

</select>

<select id="appSelectContentE" parameterType="appdocvo" resultType="appexpandvo">

	SELECT
			 A.ATYPE AS ATYPE
			,A.ANUM AS ANUM
			,A.ALEVEL AS ALEVEL
			,C.MDEPTNO AS MDEPTNO
			,C.MNAME AS MNAME
			,(SELECT ROUND(MONTHS_BETWEEN(DELETEDATE, INSERTDATE) / 12) FROM TR_APPROVAL WHERE ANUM = #{anum}) AS DELETEDATE 
			,A.AAUTH AS AAUTH
			,TO_CHAR(A.INSERTDATE,'YYYY-MM-DD HH24:mm') AS INSERTDATE
			,TO_CHAR(A.FINDATE, 'YYYY-MM-DD HH24:mm') AS FINDATE
			,A.ACONFIRM AS ACONFIRM
			,A.DELETEDATE AS DELETEDATE
			,(CASE WHEN D.PAPP IS NULL THEN A.AAPP
          	  ELSE D.PAPP END) AAPP
			,A.AREF  AS AREF
			,B.ESUBJECT AS ESUBJECT
			,B.ETYPE AS ETYPE
			,B.EDEAL AS EDEAL
			,B.EWHEN AS EWHEN
			,B.EMEMO AS EMEMO
			,B.EAMOUNT AS EAMOUNT
			,B.EPRICE AS EPRICE
			,B.ECARD AS ECARD
	FROM	TR_APPROVAL A, TR_EXPAND B, TR_MEMBER C, TR_PROXY D
	WHERE	C.MNUM = A.MNUM
	AND		A.ANUM = B.ANUM
	AND 	A.ANUM = D.ANUM(+)
	AND		A.ANUM = #{anum}

</select>

<update id="appUpdate" parameterType="appdocvo">

	UPDATE 		 TR_APPROVAL 
	SET  		 ALEVEL = #{alevel}
				,ACONFIRM = #{aconfirm}
				,UPDATEDATE = SYSDATE
	WHERE 		 DELETEYN = 'Y'
	AND 		 ANUM = #{anum}

</update>

<update id="appPassUpdate" parameterType="appdocvo">

	UPDATE 		 TR_APPROVAL 
	SET  		 ALEVEL = #{alevel}
				,ACONFIRM = #{aconfirm}
				,UPDATEDATE = SYSDATE
				,FINDATE = SYSDATE
	WHERE 		 DELETEYN = 'Y'
	AND 		 ANUM = #{anum}

</update>

<insert id="appProxyInsert" parameterType="appdocvo">
	
	INSERT INTO TR_PROXY 
	values(
	 #{anum}
	,#{aapp}
	,'Y')

</insert>

<update id="appProxyUpdate" parameterType="appdocvo">
	
	UPDATE TR_PROXY  SET PAPP = #{aapp} WHERE ANUM = #{anum}

</update>

<select id="appProxySelect" parameterType="appdocvo" resultType="appdocvo">
	
	SELECT 		ANUM, 
				PAPP AS AAPP, 
				DELETEYN 
	FROM 		TR_PROXY
	WHERE 		ANUM = #{anum}

</select>

<update id="appRejectUpdate" parameterType="appdocvo">
   
     UPDATE      TR_APPROVAL A
      SET         A.ALEVEL = '00'   
      WHERE       DELETEYN = 'Y'
      AND         A.ANUM = #{anum}
   
   
</update>

<select id="appSelectReject" parameterType="appdocvo" resultType="appdocvo">

	SELECT  
              COALESCE (A.ANUM, B.ANUM, C.ANUM) AS ANUM
             ,COALESCE (A.VSUBJECT, B.DSUBJECT,C.ESUBJECT) AS SUBJECT
             ,D.MNAME
             ,D.MPOSITION 
             ,AA.AAPP
             ,AA.AAUTH
             ,AA.ATYPE
             ,AA.ALEVEL
             ,AA.INSERTDATE
             ,AA.FINDATE
      FROM   TR_VACATION A, TR_DRAFT B, TR_EXPAND C, TR_MEMBER D,
            (SELECT  * 
             FROM		TR_APPROVAL 
           	 WHERE 		MNUM = #{mnum}
           	 AND	 ALEVEL = '00'
             ) AA
      WHERE  AA.ANUM = A.ANUM(+) 
      AND    AA.ANUM = B.ANUM(+) 
      AND    AA.ANUM = C.ANUM(+)
      AND    AA.MNUM = D.MNUM(+)


</select>

</mapper>


